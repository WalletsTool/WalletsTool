# 窗口关闭功能说明

## 功能概述

我已经为你的 Web3 工具箱应用实现了以下功能：

1. **关闭前确认弹窗**：当用户尝试关闭主窗口时，会弹出确认对话框
2. **智能子窗口检测**：系统会自动检测当前打开的子窗口数量
3. **自动关闭子窗口**：在关闭主窗口前，会先自动关闭所有子窗口
4. **用户友好的提示**：根据子窗口数量显示不同的提示信息

## 实现细节

### 后端实现 (Rust)
- **文件位置**: `src-tauri/src/main.rs`
- **新增命令**:
  - `close_all_child_windows`: 关闭所有子窗口
  - `get_all_child_windows`: 获取所有子窗口列表
- **窗口事件监听**: 监听主窗口的关闭请求并阻止默认行为
- **事件发射**: 向前端发送自定义事件 `main-window-close-requested`

### 前端实现 (Vue.js)
- **文件位置**: `src/pages/Home.vue`
- **新增功能**:
  - 监听主窗口关闭请求事件
  - 使用 Arco Design 的 Modal 组件显示确认对话框
  - 智能显示子窗口数量和相应提示
  - 优雅的关闭流程：先关闭子窗口，再关闭主窗口

## 用户体验流程

1. **无子窗口时**：
   - 用户点击关闭按钮
   - 弹出确认对话框："确定要关闭应用程序吗？"
   - 用户确认后直接关闭主窗口

2. **有子窗口时**：
   - 用户点击关闭按钮
   - 弹出确认对话框："当前还有 X 个子窗口正在运行，关闭主窗口将关闭所有窗口。确定要继续吗？"
   - 用户确认后：
     a. 系统先关闭所有子窗口
     b. 等待 500ms 确保子窗口完全关闭
     c. 最后关闭主窗口

3. **错误处理**：
   - 如果获取子窗口列表失败，显示简单的确认对话框
   - 如果关闭过程中出现错误，会显示错误提示

## 技术要点

1. **遵循开发规范**：
   - 编码使用 UTF-8 格式
   - 支持网络代理配置 (http://127.0.0.1:8595)

2. **Tauri 2.x 兼容**：
   - 使用最新的 Tauri 2.x API
   - 正确导入 Emitter trait 用于事件发射
   - 使用 webview_windows() 替代旧的 windows() 方法

3. **Vue 3 + Composition API**：
   - 使用 `onMounted` 和 `onBeforeUnmount` 生命周期
   - 正确清理事件监听器防止内存泄漏

## 测试方法

1. 启动应用程序
2. 打开一些子窗口（如余额查询、批量转账）
3. 尝试关闭主窗口
4. 验证确认对话框的显示和行为
5. 确认所有窗口都正确关闭

## 注意事项

- 确认对话框使用 Arco Design 的 Modal 组件，样式与应用整体风格一致
- 关闭按钮采用危险状态（红色）突出重要性
- 子窗口关闭后有 500ms 延迟确保完全关闭
- 所有用户操作都有相应的日志输出便于调试
- 对话框宽度优化为 320px，提供更紧凑的用户体验
- onOk 回调函数明确返回 true/false 以正确控制对话框的关闭行为
- 新增 force_close_main_window 命令解决循环弹窗问题
- 前端使用强制关闭命令避免触发窗口事件循环
